PE For Malware Analysis
========================

#### This article for reverse engineering and malware analysis . If you’re looking for details, read *[Microsoft’s PE Format](https://docs.microsoft.com/en-us/windows/win32/debug/pe-format)* .

# Introduction
### What is PE format ..?
- PE format is actually a data structure that tells Windows OS loader what information is required to run executable code .
### Why ..?

- **For Reverse Engineer and Malware analysis<br>**
Just as a surgeon should understand the human body and its parts to excel in surgery, a malware reverse engineer should understand the structure and components of a binary to be proficient in malware analysis. Within the Windows operating system, we are referring to the Portable Executable (PE) format *[Anuj Soni](https://malwology.com/2018/10/05/exploring-the-pe-file-format-via-imports/)*

- **For OS<br>**
Suppose a company wants to hire some employees, and you want to work in this company.
First they'll ask you to introduce yourself and some information about you such as your name, age, experience in your field of work, etc.
The same thing happens with *[Windows Loader](https://en.wikipedia.org/wiki/Loader_(computing))* 
When you double click on any file in your OS, Windows Loader look at PE Structure of this file to know this format, size on disk, dlls, Import table, etc. 

# Structure of PE Files
 - PE File contain two parts

    ![Portable-executable-file-format](https://user-images.githubusercontent.com/33573622/132204342-8aca41fc-feb4-44a4-9d62-8c025da31718.png)

 - we'll open *notepade.exe* in *[HxD](https://mh-nexus.de/en/hxd/)* to see this information

    ![2021-09-06 13_07_20-Window](https://user-images.githubusercontent.com/33573622/132258909-5d507e99-818a-40d2-8481-4197b8da688b.png)

## MS-Dos Header
- **Dos_Header** and **Dos_Stub** is part of MS-Dos_Header  
  - **Dos_Header** contain two important values :
    - First is `e_magic` value (4D 5A --> MZ) which tell us this is executable file and it's called *[Magic Number](https://en.wikipedia.org/wiki/List_of_file_signatures)*
    - Second is  `e_lfanew` value (F8 00 00 00) which tell us where's **File_Header** is located 
    
    ![2021-09-06 15_58_30-CFF Explorer VIII -  notepad exe](https://user-images.githubusercontent.com/33573622/132228928-ac600ebe-c0ca-4d66-9550-e2037947e19c.png)
    We use *[CFF Explorer](https://ntcore.com/?page_id=388)*

    
  - **Dos_Stub** It's just contain a piece of code that is run by default when the execution of an application starts. This stub prints out the message *“This program cannot be run in DOS mode”*

## File_Header (IMAGE_NT_HEADER)
- The PE file header is located by indexing the `e_lfanew` field of the **MS-DOS header** 
This header includes information about executable file and mainly contains three sections 
  - <h2> SIGNATURE : </h2> This feature is a signature of the beginning of the PE header.<br>
 
      ![2021-09-06 17_45_26-CFF Explorer VIII -  notepad exe](https://user-images.githubusercontent.com/33573622/132240934-6e611029-b950-41a8-859d-6ebb8b0208c7.png)

  - <h2> IMAGE_FILE_HEADER : </h2>  This contain basic information about the layout of the file<br>
 
      ![2021-09-06 17_49_58-CFF Explorer VIII -  notepad exe](https://user-images.githubusercontent.com/33573622/132241321-3c05a5ef-e41b-4288-a4df-0c81a2f140f7.png)
      
      - **Machine**              ➡️ The number that identifies the type of target machine. For more information, see *[Machine Types](https://docs.microsoft.com/en-us/windows/win32/debug/pe-format#machine-types)*
      - **NumberOfSections**     ➡️ How many sections the file contains. This indicates the size of the section table.
      - **TimeDateStamp**        ➡️ Which indicates when the file was created.
      - **PointerToSymbolTable** ➡️ The file offset of the COFF symbol table, or zero if no COFF symbol table is present.
      - **NumberOfSymbols**      ➡️ The number of entries in the symbol table. This data can be used to locate the string table.
      - **SizeOfOptionalHeader** ➡️ The size of the optional header, which is required for executable files but not for object files.
      - **Characteristics**      ➡️ Defines the type of your file. (EXE,DLL,etc)
  
  - <h2> IMAGE_OPTIONAL_HEADER : </h2> Actually it's not (optional) It's very important to us because of the information inside<br>
 
     ![2021-09-06 18_03_44-CFF Explorer VIII -  notepad exe](https://user-images.githubusercontent.com/33573622/132243806-e2584730-4f77-47c1-98ca-6abeb71cd81b.png)

    - **Magic:**                 ➡️ This identifies the state of the image file. (The most common number is 0x10b for 32-bit and 0x20b for 64-bit)
    - **AddressOfEntryPoint:**   ➡️ Where the loader will begin execution.
    - **ImageBase :**            ➡️ The preferred address of the image when loaded into memory. 
    - **SectionAlignment :**     ➡️ Dictates the minimum amount of space a section can occupy when loaded. (On RAM)
    - **FileAlignment:**         ➡️ Dictates the minimum chunks of information within the image file before it loading. (On Disk)
    - **SizeOfImage:**           ➡️ It is a hint to the loader how much size it will need to load the image in RAM
    - For other members, Read *[optional header fields](https://docs.microsoft.com/en-us/windows/win32/debug/pe-format#optional-header-standard-fields-image-only)*
    
  - <h2> Sections_Table :</h2> This is an array that contain informations related to the various sections available in the image of an executable file.<br>

     ![2021-09-06 21_47_19-CFF Explorer VIII -  notepad exe](https://user-images.githubusercontent.com/33573622/132257194-e70e823c-dd5c-45b0-97f6-6f8865c48efb.png)
   
    - **Virtual Size:**    ➡️ This section indicates the size of the section in memory
    - **Virtual Address:** ➡️ This field identifies the virtual address in the process's address space to which to load the section
    - **Raw Size:**        ➡️ 
    - **Raw Address:**     ➡️
    - **Characteristics**  ➡️ This tells about the memory access rights for that section in memory denoted as flags (R, RW, RWE, etc..)
    
  - <h2> Data_Directories :</h2> That's indicate where to find the other important components of executable information in the file. <br>
    
    ![2021-09-06 22_32_47-CFF Explorer VIII -  notepad exe](https://user-images.githubusercontent.com/33573622/132259541-ebb0c48b-27bb-4836-9af1-de9a704e56bb.png)

    
    
    
