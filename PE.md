PE For Malware Analysis
========================

⚠️ This article for reverse engineering and malware analysis . If you’re looking for details, read *[Microsoft’s PE Format](https://docs.microsoft.com/en-us/windows/win32/debug/pe-format)* .

# Table Of Content 


- [Introduction](https://github.com/sayed1337/MalwareZ/blob/main/PE.md#introduction)
    - [What is PE Format..?](https://github.com/sayed1337/MalwareZ/blob/main/PE.md#what-is-pe-format-)
    - [Why..?](https://github.com/sayed1337/MalwareZ/blob/main/PE.md#why-)
- [Structure Of PE File](https://github.com/sayed1337/MalwareZ/blob/main/PE.md#structure-of-pe-files)
    - [MS-DOS Header](https://github.com/sayed1337/MalwareZ/blob/main/PE.md#ms-dos-header)
    - [File Header (IMAGE_NT_HEADER)](https://github.com/sayed1337/MalwareZ/blob/main/PE.md#file_header-image_nt_header)
       - [SIGNITURE](https://github.com/sayed1337/MalwareZ/blob/main/PE.md#-signature--)
       - [IMAGE_FILE_HEADER](https://github.com/sayed1337/MalwareZ/blob/main/PE.md#-image_file_header--)
       - [IMAGE_OPTIONAL_HEADER](https://github.com/sayed1337/MalwareZ/blob/main/PE.md#-image_optional_header--)
       - [DATA_DIRECTORIES](https://github.com/sayed1337/MalwareZ/blob/main/PE.md#-data_directories-)

    - [Sectoins](https://github.com/sayed1337/MalwareZ/blob/main/PE.md#sections)
       - [SECTIONS_HEADR](https://github.com/sayed1337/MalwareZ/blob/main/PE.md#-sections_table-)
# Introduction
### What is PE format ..?
- PE format is actually a data structure that tells Windows OS loader what information is required to run executable code .
### Why ..?

- **For Reverse Engineer and Malware analyst<br>**
Just as a surgeon should understand the human body and its parts to excel in surgery, a malware reverse engineer should understand the structure and components of a binary to be proficient in malware analysis. *[Anuj Soni](https://malwology.com/2018/10/05/exploring-the-pe-file-format-via-imports/)*

- **For OS<br>**
Suppose a company wants to hire some employees, and you sent your CV to work in this company.
HR team will look at your CV to know information about you to see if you are suitable for this job or not.
The same thing happens with *[Windows Loader](https://en.wikipedia.org/wiki/Loader_(computing))* 
When you double click on any file in your OS, Windows Loader look at PE Structure of this file to know the necessary information to manage the executable code.


# Structure of PE Files
 - PE File contain two parts, Headers and sections.

    ![PE_Headers_Featured](https://user-images.githubusercontent.com/33573622/132375669-d8b8df92-f7c3-4e54-b98e-82134da10127.png)


 - we'll open *notepade.exe* in *[HxD](https://mh-nexus.de/en/hxd/)* to see this information

    ![2021-09-06 13_07_20-Window](https://user-images.githubusercontent.com/33573622/132258909-5d507e99-818a-40d2-8481-4197b8da688b.png)

 # MS-Dos Header 
> **Dos_Header** and **Dos_Stub** is part of MS-Dos_Header  
  - Dos_Header contain two important values :
    - First is `e_magic` value (4D 5A --> MZ) which tell us this is executable file and it's called *[Magic Number](https://en.wikipedia.org/wiki/List_of_file_signatures)*
      (MZ referring to Mark Zbikowski, who developed MS-DOS)
    - Second is  `e_lfanew` value (F8 00 00 00) which tell us where's **File_Header** is located 
    
        ![2021-09-06 15_58_30-CFF Explorer VIII -  notepad exe](https://user-images.githubusercontent.com/33573622/132228928-ac600ebe-c0ca-4d66-9550-e2037947e19c.png)
    We use *[CFF Explorer](https://ntcore.com/?page_id=388)*

    
  - Dos_Stub It's just contain a piece of code that is run by default when the execution of an application starts. This stub prints out the message *“This program cannot be run in DOS mode”*

# File_Header (IMAGE_NT_HEADER) 
>The PE file header is located by indexing the `e_lfanew` field of the **MS-DOS header**.<br>
>This header includes informations about executable file and mainly contain 3 members :
 - <h2> SIGNATURE : </h2> This feature is a signature of the beginning of the PE header.<br>
 
      ![2021-09-06 17_45_26-CFF Explorer VIII -  notepad exe](https://user-images.githubusercontent.com/33573622/132240934-6e611029-b950-41a8-859d-6ebb8b0208c7.png)

 - <h2> IMAGE_FILE_HEADER : </h2>  This contain basic information about the layout of the file<br>
 
      ![2021-09-06 17_49_58-CFF Explorer VIII -  notepad exe](https://user-images.githubusercontent.com/33573622/132241321-3c05a5ef-e41b-4288-a4df-0c81a2f140f7.png)
      
      - **Machine**              ➡️ The number that identifies the type of target machine. For more information, see *[Machine Types](https://docs.microsoft.com/en-us/windows/win32/debug/pe-format#machine-types)*
      - **NumberOfSections**     ➡️ How many sections the file contains. This indicates the size of the section table.
      - **TimeDateStamp**        ➡️ Which indicates when the file was created. (malware auther can change it)
      - **PointerToSymbolTable** ➡️ The file offset of the COFF symbol table, or zero if no COFF symbol table is present.
      - **NumberOfSymbols**      ➡️ The number of entries in the symbol table. This data can be used to locate the string table.
      - **SizeOfOptionalHeader** ➡️ The size of the optional header, which is required for executable files but not for object files.
      - **Characteristics**      ➡️ contains flags that indicate attributes of the object or image file
  
- <h2> IMAGE_OPTIONAL_HEADER : </h2> Actually it's not (optional) It's very important to us because of the information inside<br>
 
     ![2021-09-06 18_03_44-CFF Explorer VIII -  notepad exe](https://user-images.githubusercontent.com/33573622/132243806-e2584730-4f77-47c1-98ca-6abeb71cd81b.png)

    - **Magic:**                 ➡️ This identifies the state of the image file. (The most common number is 0x10b for 32-bit and 0x20b for 64-bit)
    - **AddressOfEntryPoint:**   ➡️ Where the strat of code will begin execution.
    - **ImageBase :**            ➡️ The preferred address of the image when loaded into memory. 
    - **SectionAlignment :**     ➡️ Dictates the minimum amount of space a section can occupy when loaded. (On RAM)
    - **FileAlignment:**         ➡️ Dictates the minimum chunks of information within the image file before it loading. (On Disk)
    - **SizeOfImage:**           ➡️ It is a hint to the loader how much size it will need to load the image in RAM
    - For other members, Read *[optional header fields](https://docs.microsoft.com/en-us/windows/win32/debug/pe-format#optional-header-standard-fields-image-only)*
    
      - <h2> Data_Directories :</h2> This is part of the IMAGE_OPTIONAL_HEADER structure. This field indicates where to find the other important components of executable information in the file <br> Each data directory entry specifies the size and relative virtual address of the directory. But we need some of them not all
    
           ![2021-09-07 15_45_40-CFF Explorer VIII -  notepad exe](https://user-images.githubusercontent.com/33573622/132355880-fdedf335-1a61-4eff-aa51-448dde2e1681.png)

        
         
         
           ExportDirectoryRVA ➡️ Address of exported functions<br>
           ImportDirectoryRVA ➡️ Adderss of imported functions<br>
           ResourcesDirectoryRVA ➡️ Adderss of resources such as images embedded in the PE<br>
           ImportAddressTable ➡️ which stores the runtime addresses of the imported functions.<br>
           For more inforamtion *[Tech Zealots](https://tech-zealots.com/malware-analysis/journey-towards-import-address-table-of-an-executable-file/)*




# Sections 
  - <h2> Sections_Table :</h2>

      ![2021-09-06 21_47_19-CFF Explorer VIII -  notepad exe](https://user-images.githubusercontent.com/33573622/132257194-e70e823c-dd5c-45b0-97f6-6f8865c48efb.png)
   
      - **Virtual Size:**    ➡️ This section indicates the size of the section in memory
      - **Virtual Address:** ➡️ This field identifies the virtual address in the process's address space to which to load the section
      - **Raw Size:**        ➡️ This specifies the real size of the section in the file
      - **Raw Address:**     ➡️ This field identifies the raw address before execute (offest)
      - **Characteristics**  ➡️ This tells about the memory access rights for that section in memory denoted as flags (R, RW, RWE, etc..)
    
 - <h2> Sections_Names </h2>
    
